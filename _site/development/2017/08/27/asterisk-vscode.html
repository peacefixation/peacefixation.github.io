<!DOCTYPE html>
<html>

    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Asterisk syntax highlighting extension for Visual Studio Code</title>
    <meta name="description" content="I’ve started using Microsoft’s new Visual Studio Code text editor at work and it’s pretty neat. I like it more than the Brackets editor that I was using befo...">

    <link rel="stylesheet" href="/css/main.css">

    
    
    
    
    
    
    <link rel="canonical" href="http://peacefixation.github.io/development/2017/08/27/asterisk-vscode.html">
    <link rel="alternate" type="application/rss+xml" title="Matt Jarvis" href="http://peacefixation.github.io/feed.xml">
</head>


    <body>

    <header class="site-header">

    <div class="wrapper">

        <a class="site-title" href="/">Matt Jarvis</a>

        <nav class="site-nav">
            <a href="#" class="menu-icon">
                <svg viewBox="0 0 18 15">
                <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
                <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
                <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
                </svg>
            </a>

            <div class="trigger">
                
                    
                        <a class="page-link" href="/categories/">Categories</a>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        <a class="page-link" href="/links/">Links</a>
                    
                
                    
                
            </div>
        </nav>

    </div>

</header>


        <div class="page-content">
            <div class="wrapper">

                <div id="content">
                    
                    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Asterisk syntax highlighting extension for Visual Studio Code</h1>
        <p class="post-meta"><time datetime="2017-08-27T18:00:00+10:00" itemprop="datePublished">Aug 27, 2017</time></p>
    </header>

    <div class="post-content" itemprop="articleBody">
        <p>I’ve started using Microsoft’s new <a href="https://code.visualstudio.com/">Visual Studio Code</a> text editor at work and it’s pretty neat. I like it more than the Brackets editor that I was using before. It’s similar, but more polished and has some excellent features like an integrated terminal and a debugger. As you might expect there is a comprehensive extension repository but once again there was no syntax highlighter for Asterisk dialplan code so I took it upon myself to fill the void and wrote one. This time around there was no existing language grammar for me to use, so it was a slightly more formidable undertaking.</p>

<p>If you’d like to make your own extension I’d recommend following the <a href="https://code.visualstudio.com/docs/extensions/overview">extensive documentation</a> to get started, it’s all explained very well and I won’t repeat it here. You can <code class="highlighter-rouge">npm install</code> Yeoman and the VS Code Extension Generator to create the boiler plate including a howto reference which is nice to have on hand.</p>

<p>The extension framework is fairly simple, define the extension properties in <code class="highlighter-rouge">package.json</code> and create a <code class="highlighter-rouge">syntaxes/asterisk.tmLanguage</code> file for the TextMate grammar. A few extra features are defined in the <code class="highlighter-rouge">language-configuration.json</code> file, such as the comment character, character pairs that will be auto-closed and characters that can be used to surround a selection, like quote marks or braces.</p>

<p>Syntax highlighting extensions use the TextMate framework for language grammars, similar to Atom and Sublime and .. well, TextMate. A grammar is defined by defining a regex that will match a syntax element and then setting a scope. The scope might be <code class="highlighter-rouge">comment.quoted</code> or <code class="highlighter-rouge">meta.function</code> and depending on your current colour theme, each scope will take on a certain colour and style in your editor.</p>

<p>Fully fledged language extensions (i.e. intellisense, auto-correct) are much more complex, I didn’t need such features for this extension.</p>

<h1 id="the-grammar">The Grammar</h1>

<p>Creating the regexes for the Asterisk dialplan grammar was equal parts easy and hard. I don’t know of an official definition for the grammar so I just worked with the syntax that I know, and the little documentation there is. This is further compounded by the fact that I work with an older version of Asterisk (1.6), so there is some newer syntax I’m not familiar with. In any case, I did what I could, and I will improve the extension as I can.</p>

<p>Matching keywords, or a variable definition, or a function call was pretty easy. It was harder to match a variable inside a quoted string inside a function call, but it was all possible, and after some trial and error I have it working quite nicely.</p>

<p>Here’s an example of a simple match for a file import declaration like <code class="highlighter-rouge">#include extensions.conf</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;dict&gt;
    &lt;key&gt;match&lt;/key&gt;
    &lt;string&gt;^#include&lt;/string&gt;
    &lt;key&gt;name&lt;/key&gt;
    &lt;string&gt;keyword.control.import&lt;/string&gt;
&lt;/dict&gt;
</code></pre>
</div>

<p>Here’s an example of a much more complicated match on a variable that can contain a nested variable <code class="highlighter-rouge">${CHANNEL_${MAX_CHANNELS}}</code>, or a nested function <code class="highlighter-rouge">${CDR(accountcode)}</code>. They key to effectively writing this match was capturing the open and closing parts, then capturing the nested function and including a match on <code class="highlighter-rouge">$self</code> for nested variables before finally matching on the rest of the inner text with a match on anything that isn’t the closing part.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;key&gt;VariableNested&lt;/key&gt;
&lt;dict&gt;
    &lt;key&gt;begin&lt;/key&gt;
    &lt;string&gt;(\$\{)&lt;/string&gt;
    &lt;key&gt;beginCaptures&lt;/key&gt;
    &lt;dict&gt;
        &lt;key&gt;1&lt;/key&gt;
        &lt;dict&gt;
            &lt;key&gt;name&lt;/key&gt;
            &lt;string&gt;variable&lt;/string&gt;
        &lt;/dict&gt;
    &lt;/dict&gt;
    &lt;key&gt;end&lt;/key&gt;
    &lt;string&gt;(\})&lt;/string&gt;
    &lt;key&gt;endCaptures&lt;/key&gt;
    &lt;dict&gt;
        &lt;key&gt;1&lt;/key&gt;
        &lt;dict&gt;
            &lt;key&gt;name&lt;/key&gt;
            &lt;string&gt;variable&lt;/string&gt;
        &lt;/dict&gt;
    &lt;/dict&gt;
    &lt;key&gt;patterns&lt;/key&gt;
    &lt;array&gt;
        &lt;dict&gt;
            &lt;key&gt;include&lt;/key&gt;
            &lt;string&gt;#FunctionNested&lt;/string&gt;
        &lt;/dict&gt;
        &lt;dict&gt;
            &lt;key&gt;include&lt;/key&gt;
            &lt;string&gt;$self&lt;/string&gt;
        &lt;/dict&gt;
        &lt;dict&gt;
            &lt;key&gt;match&lt;/key&gt;
            &lt;string&gt;[^}]&lt;/string&gt;
            &lt;key&gt;name&lt;/key&gt;
            &lt;string&gt;variable&lt;/string&gt;
        &lt;/dict&gt;
    &lt;/array&gt;
&lt;/dict&gt;
</code></pre>
</div>

<p>A cool feature of the grammar file is the repository. You can create a repository of named matches using the <code class="highlighter-rouge">&lt;repository&gt;</code> tag. Once defined, you can include a named match in the main part of the file as required. This could be a top level match, or a sub level match. In my grammar, I define a variable, and then I include it as a stand alone variable, as a nested variable inside a quoted string, as a nested variable inside a function and also as a nested variable inside an expression. Don’t repeat yourself! :)</p>

<p>I found the <a href="http://manual.macromates.com/en/">TextMate manual</a> and the <a href="https://www.sublimetext.com/docs/3/scope_naming.html">Sublime scope naming page</a> very helpful. I also dug out the colour theme definitions inside the VS Code folder to see which scopes the included themes target for highlighting. I ended up choosing some scopes that were semantically incorrect, but resulted in a better highlight across multiple themes. I don’t feel particularly good about that, but at the end of the day, better highlighting means faster Asterisk dialplan development, so I compromised on correctness.</p>

<p>Publishing the extension was simple, but you do need to create a Visual Studio Team System (VSTS) account in order to generate a <code class="highlighter-rouge">Personal Access Token</code>. The <a href="https://code.visualstudio.com/docs/extensions/publish-extension">documentation</a> walks you through the process. Once you have your token, publish the extension by running <code class="highlighter-rouge">vsce publish -p &lt;token&gt;</code> and you’re done!</p>

<p>You can see the full extension code on <a href="https://github.com/peacefixation/asterisk-vscode">Github</a>.</p>

    </div>

</article>

                
                </div>
            </div>
        </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="social-media-list">
          <li>
              <a href="/feed.xml"><span class="icon"><?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg"
     id="RSSicon"
     viewBox="0 0 8 8" width="256" height="256">

  <title>RSS feed icon</title>

  <style type="text/css">
    .button {stroke: none; fill: none;}
    .symbol {stroke: none; fill: #828282;}
  </style>

  <rect   class="button" width="8" height="8" rx="1.5" />
  <circle class="symbol" cx="2" cy="6" r="1" />
  <path   class="symbol" d="m 1,4 a 3,3 0 0 1 3,3 h 1 a 4,4 0 0 0 -4,-4 z" />
  <path   class="symbol" d="m 1,2 a 5,5 0 0 1 5,5 h 1 a 6,6 0 0 0 -6,-6 z" />

</svg></span> rss</a>

          </li>
          
          <li>
            <a href="https://github.com/peacefixation"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">peacefixation</span></a>

          </li>
          

          
            
          
          <li>
              <a href="http://stackoverflow.com/users/966798/matt"><span class="icon"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Created with Inkscape (http://www.inkscape.org/) -->

<svg
   xmlns:dc="http://purl.org/dc/elements/1.1/"
   xmlns:cc="http://creativecommons.org/ns#"
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   width="100%"
   height="100%"
   id="svg4231"
   version="1.1"
     viewBox="0 0 64 64"
   inkscape:version="0.47 r22583"
   sodipodi:docname="New document 26">
  <defs
     id="defs4233">
    <inkscape:perspective
       sodipodi:type="inkscape:persp3d"
       inkscape:vp_x="0 : 32 : 1"
       inkscape:vp_y="0 : 1000 : 0"
       inkscape:vp_z="64 : 32 : 1"
       inkscape:persp3d-origin="32 : 21.333333 : 1"
       id="perspective4239" />
    <inkscape:perspective
       id="perspective4219"
       inkscape:persp3d-origin="0.5 : 0.33333333 : 1"
       inkscape:vp_z="1 : 0.5 : 1"
       inkscape:vp_y="0 : 1000 : 0"
       inkscape:vp_x="0 : 0.5 : 1"
       sodipodi:type="inkscape:persp3d" />
  </defs>
  <sodipodi:namedview
     id="base"
     pagecolor="#ffffff"
     bordercolor="#666666"
     borderopacity="1.0"
     inkscape:pageopacity="0.0"
     inkscape:pageshadow="2"
     inkscape:zoom="3.8890873"
     inkscape:cx="-15.758389"
     inkscape:cy="39.724597"
     inkscape:current-layer="layer1"
     showgrid="true"
     inkscape:document-units="px"
     inkscape:grid-bbox="true"
     inkscape:window-width="1280"
     inkscape:window-height="674"
     inkscape:window-x="0"
     inkscape:window-y="24"
     inkscape:window-maximized="1" />
  <metadata
     id="metadata4236">
    <rdf:RDF>
      <cc:Work
         rdf:about="">
        <dc:format>image/svg+xml</dc:format>
        <dc:type
           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
        <dc:title></dc:title>
      </cc:Work>
    </rdf:RDF>
  </metadata>
  <g
     id="layer1"
     inkscape:label="Layer 1"
     inkscape:groupmode="layer">
    <path
       style="fill:#919191;fill-opacity:1;stroke:none"
       id="path2830"
       d="m 8.2066776,36.963544 4.4013074,0.04316 -0.153441,19.598393 29.291258,0 0,-19.527506 4.637782,0 0,24.287331 -38.200679,0 0.023777,-24.401371 z" />
    <rect
       style="fill:#919191;fill-opacity:1;stroke:none"
       id="rect3604"
       y="48.549992"
       x="15.383667"
       height="4.881876"
       width="22.944817" />
    <rect
       style="fill:#919191;fill-opacity:1;stroke:none"
       id="rect3606"
       transform="matrix(0.9953749,0.09606666,-0.09606666,0.9953749,0,0)"
       y="38.051189"
       x="19.667879"
       height="5.0039229"
       width="23.066864" />
    <rect
       style="fill:#919191;fill-opacity:1;stroke:none"
       id="rect3606-1"
       transform="matrix(0.96240291,0.27162592,-0.27162592,0.96240291,0,0)"
       y="23.81143"
       x="25.447008"
       height="5.0039229"
       width="23.066864" />
    <rect
       style="fill:#919191;fill-opacity:1;stroke:none"
       id="rect3606-1-3"
       transform="matrix(0.85597805,0.51701216,-0.51701216,0.85597805,0,0)"
       y="3.8206301"
       x="29.64859"
       height="5.0039229"
       width="23.066864" />
    <rect
       style="fill:#919191;fill-opacity:1;stroke:none"
       id="rect3606-1-3-7"
       transform="matrix(0.58242689,0.81288309,-0.81288309,0.58242689,0,0)"
       y="-23.514734"
       x="26.646437"
       height="5.0039229"
       width="23.066864" />
    <rect
       style="fill:#919191;fill-opacity:1;stroke:none"
       id="rect3606-1-3-7-6"
       transform="matrix(0.16480989,0.98632535,-0.98632535,0.16480989,0,0)"
       y="-49.081326"
       x="11.107887"
       height="5.0039229"
       width="23.066864" />
  </g>
</svg>
</span><span class="username">matt</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-2">
          <p>I'm a developer for a VoIP provider and do most of my work with Java and Asterisk. In my spare time I ride my mountain bike and listen to groovy music.
</p>
      </div>
    </div>

  </div>

</footer>


    </body>

</html>
